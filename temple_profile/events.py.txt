import frappe

def on_new_record(doc, method):
    # 1. Standard Flag Check
    if doc.flags.via_custom_importer:
        return

    try:
        # 2. Validation: Ensure we actually have a mobile number to check
        if not doc.mobile_number:
            return

        # FIX 1: Use 'filters' (plural), not 'filter'
        profile_data = frappe.db.get_all(
            'Temple Profile', 
            filters={'mobile_number': doc.mobile_number}, 
            fields=["name", "full_name", 'mobile_number', 'email_id']
        )
        
        length = len(profile_data)

        # --- Case 1: Exactly One Match ---
        if length == 1:
            # FIX 2: Get the first item from the list
            existing_profile = profile_data[0]
            
            # FIX 3: Use db_set to save the link without triggering a full save loop
            doc.db_set('temple_id', existing_profile.name)
            
            frappe.msgprint(f"Linked to existing Temple Profile: {existing_profile.name}")

        # --- Case 2: No Match (Create New) ---
        elif length == 0:
            if not doc.full_name:
                frappe.throw("Cannot create Temple Profile: Field 'Full Name' is missing.")

            new_temple_profile = frappe.get_doc({
                "doctype": "Temple Profile",
                "full_name": doc.full_name,
                "mobile_number": doc.mobile_number,
                "email_id": doc.email_id if doc.email_id else "NaN"
            })
            
            new_temple_profile.insert(ignore_permissions=True)
            
            # Link the new ID back to the current document
            doc.db_set('temple_id', new_temple_profile.name)
            
            frappe.msgprint(f'Created new Temple Profile: {new_temple_profile.name}')

        # --- Case 3: Multiple Matches (Create Request) ---
        else:
            duplicate_rec = frappe.get_doc({
                "doctype": "TP Creation Request",
                "full_name": doc.full_name,
                "mobile_number": doc.mobile_number,
                "description": f"Multiple records with same mobile number found while creating {doc.doctype} Entry",
                "source_doc_type": doc.doctype,
                "conflicting_records": [] 
            })

            for row in profile_data:
                # FIX 4: Use 'row' (the current item), NOT 'profile_data' (the list)
                duplicate_rec.append("conflicting_records", {
                    "full_name": row.full_name,
                    "mobile_number": row.mobile_number,
                    "email_id": row.email_id if row.email_id else "NaN",
                    'temple_id':row.name
                })
            
            # Insert AFTER the loop is finished
            duplicate_rec.insert(ignore_permissions=True)
            
            frappe.throw(f'Duplicate detected. Created Request: {duplicate_rec.name}')

    except frappe.exceptions.DuplicateEntryError:
        frappe.msgprint("Warning: Duplicate Entry Error occurred.", alert=True)

    except Exception as e:
        # Log the full error trace for debugging
        frappe.log_error(title=f"Temple Profile Link Error for {doc.name}")
        frappe.msgprint("Error linking Temple Profile. Check Error Log for details.", alert=True)